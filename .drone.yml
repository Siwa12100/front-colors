# ============================================================
# PIPELINE UNIQUE : Build + Tests + Sonar + Docker + Deploy
# ============================================================
kind: pipeline
type: docker
name: ci-main

trigger:
  branch:
    - main
  event:
    - push

volumes:
  - name: shared-volume
    temp: {}

steps:
  # â”€â”€ Ã‰tape 1 : Build + Tests en parallÃ¨le â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: "ğŸ›  build"
    image: node:22-alpine
    commands:
      - echo "ğŸ›  [INFO] Build du projet Colors..."
      - npm ci || {
          echo "âŒ [ERROR] L'installation des dÃ©pendances a Ã©chouÃ©.";
          exit 1;
        }
      - npx ng build --configuration production || {
          echo "âŒ [ERROR] Le build a Ã©chouÃ©.";
          exit 1;
        }
      - echo "âœ… [SUCCESS] Build terminÃ© avec succÃ¨s."

  - name: "ğŸ§ª tests-unitaires"
    image: node:22-alpine
    environment:
      API_BASE_URL:
        from_secret: API_BASE_URL
    volumes:
      - name: shared-volume
        path: /coverage
    commands:
      - echo "ğŸ§ª [INFO] Installation des dÃ©pendances..."
      - npm ci
      - echo "ğŸ§ª [INFO] Lancement des tests avec couverture..."
      - npx ng test --watch=false --coverage || {
          echo "âŒ [ERROR] Les tests ont Ã©chouÃ©.";
          exit 1;
        }
      - echo "ğŸ” [DEBUG] Copie du rapport de couverture..."
      - cp -r coverage/colors/* /coverage/     # ğŸ‘ˆ on entre dans le sous-dossier
      - echo "ğŸ” [DEBUG] Contenu de /coverage/ :"
      - ls -la /coverage/
      - echo "âœ… [SUCCESS] Tests terminÃ©s avec couverture."


  # â”€â”€ Ã‰tape 2 : Sonar + Build Docker en parallÃ¨le â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: "ğŸ“Š analyse-sonar"
    image: sonarsource/sonar-scanner-cli:latest
    depends_on:
      - "ğŸ§ª tests-unitaires"
    environment:
      SONAR_HOST_URL: https://sonar.davalada.valorium-mc.fr
      SONAR_TOKEN:
        from_secret: SONAR_TOKEN
    volumes:
      - name: shared-volume
        path: /coverage
    commands:
      - echo "ğŸ“Š [INFO] Initialisation de l'analyse Sonar..."
      - echo "ğŸ” [DEBUG] VÃ©rification du rapport de couverture..."
      - ls -la /coverage/
      - mkdir -p /tmp/scannerwork
      - sonar-scanner
          -Dsonar.projectKey=colors-main
          -Dsonar.host.url=$SONAR_HOST_URL
          -Dsonar.token=$SONAR_TOKEN
          -Dsonar.sources=src
          -Dsonar.tests=tests
          -Dsonar.javascript.lcov.reportPaths=/coverage/lcov.info
          -Dsonar.working.directory=/tmp/scannerwork || {
          echo "âŒ [ERROR] L'analyse Sonar a Ã©chouÃ©.";
          exit 1;
        }
      - echo "âœ… [SUCCESS] Analyse Sonar terminÃ©e."

  - name: "ğŸ³ build-push-img-main"
    image: plugins/docker
    depends_on:
      - "ğŸ›  build"
    settings:
      registry: registry.davalada.valorium-mc.fr
      repo: registry.davalada.valorium-mc.fr/colors-main
      username:
        from_secret: DOCKER_USERNAME
      password:
        from_secret: DOCKER_PASSWORD
      dockerfile: Dockerfile
      tags:
        - latest

  # â”€â”€ Ã‰tape 3 : Deploy (dÃ©pend du build Docker) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: "ğŸš€ deploiement-vps-main"
    image: appleboy/drone-ssh
    depends_on:
      - "ğŸ³ build-push-img-main"
    settings:
      host: ecirada.valorium-mc.fr
      username:
        from_secret: SSH_USER
      ssh_key:
        from_secret: SSH_PRIVATE_KEY
      port: 22
      script:
        - echo "ğŸš€ [INFO] DÃ©ploiement de Colors (main) en cours..."
        - cd deploiements/colors-main
        - echo "ğŸ›‘ [INFO] ArrÃªt de l'ancien service..."
        - docker compose down
        - echo "ğŸ“¥ [INFO] Pull de la derniÃ¨re image depuis le registry..."
        - docker compose pull
        - echo "ğŸš€ [INFO] Lancement du service..."
        - docker compose up -d
        - sleep 5
        - docker ps | grep colors-main || {
            echo "âŒ [ERROR] Le service ne tourne pas !";
            exit 1;
          }
        - echo "âœ… [SUCCESS] DÃ©ploiement de Colors (main) terminÃ© avec succÃ¨s."
